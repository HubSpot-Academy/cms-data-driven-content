{# Module data #}

{% set companies = [] %}

{# Pulls data from CRM #}
{% set dataQueryData = module.data_query.data.CRM %}
{% set companyData = dataQueryData.company_filter_options.items %}
{% set selectedCompany = module.data_query.data.CRM.company_collection %}

{# Goes through each value for company and appends them to a companies array #}

{% for filterOption in companyData %}
  {% do companies.append(filterOption.name) %}
{% endfor %}    


{# Filters values in arrays to make sure they are unique #}

{% set uniqueCompanies = companies|unique %}


{# Pulls books out of CRM object #}
{% set books = [] %}
{% set companyBooks = selectedCompany.items[0].associations.p_books_collection__books_to_company %}
{% for book in companyBooks.items %}
  {% do books.append(book) %}
{% endfor %}

{{selectedCompany||pprint}}



{# Offset, limit, current page, and total pages for pagination #}

{% set limit = 5 %}


{# Comany filter bar #}

<div class="role-filter-wrapper">
  <div class="role-filter-inner-wrapper content-wrapper">

    <div class="role-filter">
      <label class="role-filter__label" for="company">Filter by Book Store:</label>
      <select id="company">
        <option value="">Choose Book Store</option>
        {% for company in uniqueCompanies %}
          <option value="{{ company }}">{{ company }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

{# book listing #}

<div class="card-listing content-wrapper card-listing--{{ module.cards_per_row }}-cols">

  {% if books|length == 0 %}
    <h2>No results found</h2>
  {% endif %}

  {# book cards #}
  

  {% for book in books %}

    <section class="card">
      <h2 class="card__heading">{{ book.title }}</h2>
      <h3 class="card__subheading">{{ book.author }}</h3>
   
    </section>
  {% endfor %}

</div>



{# Module JavaScript #}

{% require_js %}
  <script>
    
    window.onload = function() {
  
      // Construct URL object using current browser URL
      var url = new URL(document.location);

      // Get query parameters object
      var params = url.searchParams;
      console.log(`this is the url ${params}`);

      // Set it as the dropdown value
     if (params.get('company')) {
       document.querySelector('#company').value = params.get('company');
     }

      // Triggers changeFilter function on change of one of the filter select fields
      document.querySelector('#company').addEventListener('change', function() {
        //console.log('Selected a new company: ' + document.querySelector('#company').selectedIndex);
        changeFilter('company', '#company', document.querySelector('#company').selectedIndex !== 0);
      });

      // Filters posts
      function changeFilter(filterName, divName, searchByCompany) {
        let urlParams = new URLSearchParams(document.location.search.substring(1));
        //console.log('Setting Parameter: ' + filterName + ': ' + document.querySelector(divName).value);
        setQueryParam(filterName, document.querySelector(divName).value, urlParams);
        setQueryParam('offset', 0, urlParams);
        setQueryParam('searchByCompany', searchByCompany, urlParams)
        //console.log('URL PARAMS: ');
        //console.log(urlParams);
        window.location.search = urlParams.toString();
      }
      
      

      function setQueryParam(paramName, paramValue, urlParams) {
        if (paramValue == null || paramValue === '') {
          urlParams.delete(paramName);
        } else {
          urlParams.set(paramName, paramValue);
        }
      }
    }
  </script>
{% end_require_js %}